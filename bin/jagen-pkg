#!/bin/sh

. "${jagen_dir:?}/lib/pkg.sh" || die

pkg_name="${1:?}"
pkg_stage="${2:?}"
pkg_config="$3"

pkg_qname=${pkg_name}${pkg_config:+__${pkg_config}}

pkg_log="${jagen_log_dir:?}/${pkg_name}__${pkg_stage}${pkg_config:+__${pkg_config}}.log"
pkg_work_dir="${jagen_build_dir:?}/$pkg_name"

: >"$pkg_log"

cd "$jagen_build_dir" || die

if [ "$pkg_config" ]; then
    import "config/$pkg_config" || die
fi

pkg_build_dir="$pkg_work_dir${pkg_config:+/$pkg_config}"

try_include "$jagen_include_dir/${pkg_name}__.sh" || die
try_include "$jagen_include_dir/${pkg_qname}.sh"  || die
import "pkg/$pkg_name" || die

pkg_install_dir="$pkg_dest_dir$pkg_prefix"

case $pkg_stage in
    unpack)
        cd "$jagen_build_dir"
        ;;
    patch)
        [ "$pkg_source_dir" ] || exit 0
        pkg_run cd "$pkg_source_dir"
        ;;
    *)
        if [ "$pkg_build_dir" ]; then
            pkg_run mkdir -p "$pkg_build_dir"
            pkg_run cd "$pkg_build_dir"
        fi ;;
esac

run_stage() {
    local stage="$1"
    local pkg="$pkg_name${pkg_config:+ ($pkg_config)}"

    if is_function "$stage"; then
        debug "$pkg: $stage"
        eval "$stage" >>"$pkg_log" 2>&1 ||
            die "failed to run $pkg_stage stage of package $pkg"
    else
        return 2
    fi
}

run_stage "jagen_pkg_${pkg_stage}_${pkg_config}" ||
    run_stage "jagen_pkg_${pkg_stage}"

exit 0
