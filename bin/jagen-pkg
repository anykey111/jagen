#!/bin/sh

. "$jagen_dir/lib/pkg.sh" || die "Failed to load pkg env"

pkg_name="$1"
pkg_stage="$2"
pkg_config="$3"

pkg_log="${jagen_log_dir}/${pkg_name}-${pkg_stage}${pkg_config:+-${pkg_config}}.log"
pkg_work_dir="$jagen_build_dir/$pkg_name"

: >"$pkg_log"

cd "$jagen_build_dir" || die "failed to cd to $jagen_build_dir"

if [ "$pkg_config" ]; then
    use_env "$pkg_config"
fi

if [ "$pkg_config" = 'host' ]; then
    pkg_system="$jagen_host_system"
    pkg_prefix="$jagen_host_prefix"
    pkg_dest_dir="$jagen_host_dir"
elif [ "$pkg_config" = 'target' ]; then
    pkg_system="$jagen_target_system"
    pkg_prefix="$jagen_target_prefix"
    pkg_dest_dir="$jagen_target_dir"
elif [ "$pkg_config" = 'tools' ]; then
    pkg_system="$jagen_host_system"
    pkg_prefix=""
    pkg_dest_dir="$jagen_tools_dir"
fi

include "$jagen_include_dir/$pkg_name"
import "pkg/$pkg_name"

run_stage() {
    local stage="$1"
    local pkg="$pkg_name${pkg_config:+ ($pkg_config)}"
    if is_function "$stage"; then
        debug "$pkg: $stage"
        eval "$stage" >>"$pkg_log" 2>&1 ||
            die "Failed to run '$stage' stage of package $pkg"
    fi
}

if [ "$pkg_build_dir" ]; then
    if ! [ -d "$pkg_build_dir" ]; then
        pkg_run mkdir -p "$pkg_build_dir"
    fi
    pkg_run cd "$pkg_build_dir"
fi

run_stage "jagen_pkg_${pkg_stage}_pre"

if is_function "jagen_pkg_${pkg_stage}_${pkg_config}"; then
    run_stage "jagen_pkg_${pkg_stage}_${pkg_config}"
else
    run_stage "jagen_pkg_${pkg_stage}"
fi

run_stage "jagen_pkg_${pkg_stage}_post"
