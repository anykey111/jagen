#!/bin/sh

[ "$jagen_root" ] ||
    { echo "jagen_root is not set, please source env.sh in the project root.";
      exit 1; }

. "$jagen_root/lib/pkg.sh" ||
    { echo "Failed to load pkg environment"; exit 1; }
. "$jagen_root/lib/help.sh" ||
    { echo "Failed to load help"; exit 1; }

if [ $# = 0 ]; then
    print_help
    exit
fi

build_file="$pkg_build_dir/build.ninja"
rules_file="$pkg_lib_dir/rules.${pkg_sdk}.lua"

case $1 in
    help)
        print_help
        ;;
    clean)
        p_clean_dir "$pkg_build_dir"
        exec jagen refresh
        ;;
    update)
        if p_src_is_dirty "$jagen_root"; then
            warning "$jagen_root is dirty, not updating"
        else
            p_src_pull "$jagen_root"
        fi
        exec jagen refresh
        ;;
    refresh)
        message "Refreshing build rules"
        _jagen generate "$build_file" "$rules_file" ||
            die "Failed to generate build rules"
        include "$jagen_root/lib/toolchain"
        generate_toolchain_wrappers
        ;;
    build)
        shift
        _jagen build "$build_file" "$@" || die "Build failed"
        ;;
    rebuild)
        shift
        _jagen rebuild "$build_file" "$@" || die "Rebuild failed"
        ;;
    *)
        _jagen "$@"
        ;;
esac
