#!/bin/sh

[ "$ja_root" ] ||
    { echo "ja_root is not set, please source env.sh in the project root.";
      exit 1; }

. "$ja_root/lib/pkg.sh" ||
    { echo "Failed to load pkg environment"; exit 1; }

print_help() {
    echo "Usage: $0 <COMMAND> [OPTIONS]...

Generates and manages a build system from predefined rules.

Commands:
  help		Print this help message
  clean		Delete the build directory ($pkg_build_dir)
  update	Update jagen and regenerate the build system
  refresh	Regenerate the build system
  build		Build the specified targets
  rebuild	Rebuild the specified targets showing the logs to stdout

  The build and rebuild commands accept target file names without directory.
  To see the full list use the command:

    ninja -f \"$pkg_build_dir/build.ninja\" -t targets all

  The target list is optional for the build command, if supplied only those
  targets will be built.

  The rebuild command have an optional arguments (in this order only):

    jagen rebuild [--targets-only] [--show-all] <TARGETS>...

  With the '--targets-only' option only the specified targets will be built
  (similar to the 'build' command).

  With the '--show-all' option all logs from the build directory will be shown
  instead of from the supplied targets only.

  The logs will not be shown if the targets were not previously built or the
  build directory was clean.

CONFIGURATION:

  User can supply additional configuration in \"~/.config/jagen/env.sh\" and
  \"<jagen>/local.sh\" files. These are sourced during the build process and
  should be the shell variable declarations, for example:

  export ja_sdk=\"sigma\"
  export pkg_build_dir=\"/tmp/build\"
  export pkg_source_exclude=\"chicken karaoke-player\"

NOTES:

  Targets with names ending with 'clean' usually wipe their respective package
  working and source directories. Add package names to the 'pkg_source_exclude'
  configuration variable as in the example above to stop the build scripts from
  touching their source directories (build directories will still be wiped).
"
}

if [ $# = 0 ]; then
    print_help
    exit
fi

build_file="$pkg_build_dir/build.ninja"

build() {
    local IFS tab
    local target target_path targets

    IFS="$(printf '\n\t')"; tab="$(printf '\t')"

    for target in "$@"; do
        target_path="$pkg_build_dir/$target"
        targets="${targets}${tab}${target_path}"
    done

    ninja -f "$build_file" $targets

    return $?
}

rebuild() {
    local IFS tab
    local targets_only show_all
    local target target_path targets logs status
    local rebuild_log

    IFS="$(printf '\n\t')"; tab="$(printf '\t')"

    [ "$1" = "--targets-only" ] && { shift; targets_only=1; }
    [ "$1" = "--show-all" ] && { shift; show_all=1; }

    rebuild_log="$pkg_build_dir/rebuild.log"
    : > "$rebuild_log"

    for target in "$@"; do
        target_path="$pkg_build_dir/$target"
        targets="${targets}${tab}${target_path}"
        logs="${logs}${tab}${target_path}.log"
        if [ -f "$target_path" ]; then
            rm -f "$target_path"
        else
            warning "Target $target is not exists"
        fi
    done

    [ "$targets" ] || die "No targets specified, nothing to rebuild"

    if [ "$show_all" ]; then
        tail -qFn0 "$pkg_build_dir"/*.log 2>/dev/null &
    else
        tail -qFn0 $logs "$rebuild_log" 2>/dev/null &
    fi

    if [ "$targets_only" ]; then
        ninja -f "$build_file" $targets >"$rebuild_log"; status=$?
    else
        ninja -f "$build_file" >"$rebuild_log"; status=$?
    fi

    kill $!
    return $status
}

rebuild_chibi() {
    debug "Rebuilding Chibi Scheme"
    for s in clean unpack build install; do
        "$ja_bin_dir/jagen-pkg" chibi-scheme $s tools \
            || die "Failed to $s chibi-scheme"
    done
}

case $1 in
    help)
        print_help
        ;;
    clean)
        p_clean_dir "$pkg_build_dir"
        ;;
    update)
        p_src_pull .
        exec jagen refresh
        ;;
    refresh)
        use_env tools
        p_in_path chibi-scheme || rebuild_chibi
        $ja_bin generate "$build_file" "$ja_lib_dir/rules.scm" ||
            die "Failed to generate build rules"
        ;;
    build)
        shift
        build "$@" || die "Build failed"
        ;;
    rebuild)
        shift
        rebuild "$@" || die "Rebuild failed"
        ;;
    *)
        die "Unknown command: $1"
        ;;
esac
