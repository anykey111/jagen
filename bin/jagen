#!/bin/sh

print_help() {
    echo "Usage: $0 <COMMAND> <OPTIONS>...
Generates a build system.

Commands:
  help		print this help message
  refresh	regenerate build system"
}

[ "$ja_root" ] || { echo "ja_root is not set"; exit 1; }

. "$ja_root/lib/pkg.sh" ||
    { echo "Failed to load pkg environment"; exit 1; }

if [ $# = 0 ]; then
    print_help
    exit
fi

case $1 in
    help)
        print_help
        ;;
    clean)
        if [ -d "$pkg_build_dir" ]; then
            rm -rf "$pkg_build_dir"/* ||
                die "Failed to clean $pkg_build_dir"
        fi
        ;;
    update)
        p_src_pull .
        use_env tools
        if ! $(which chibi-scheme >/dev/null 2>&1); then
            for s in clean unpack build install; do
                "$ja_bin_dir/jagen-pkg" chibi-scheme $s tools \
                    || die "Failed to $s chibi-scheme"
            done
        fi
        exec jagen refresh
        ;;
    refresh)
        use_env tools
        $(which chibi-scheme >/dev/null 2>&1) ||
            die "Could not find chibi-scheme, try update"
        $ja_bin generate build.ninja "$ja_lib_dir/rules.scm" ||
            die "Failed to generate build rules"
        ;;
    build)
        shift
        ninja "$@" || die "Build failed"
        ;;
    rebuild)
        shift
        target="$1"; log="${1}.log"
        rm -f "$target"
        : > "$log"; tail -F "$log" 2>/dev/null &
        ninja "$target" >/dev/null; status=$?
        kill $!; exit $status
        ;;
    *)
        die "Unknown command: $1"
        ;;
esac
