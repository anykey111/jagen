#!/bin/sh

print_help() {
    echo "Usage: $0 <COMMAND> <OPTIONS>...
Generates a build system.

Commands:
  help		print this help message
  refresh	regenerate build system"
}

[ "$ja_root" ] || { echo "ja_root is not set"; exit 1; }

. "$ja_root/lib/pkg.sh"
use_env tools

if [ $# = 0 ]; then
    print_help
    exit
fi

case $1 in
    help)
        print_help
        ;;
    clean)
        if [ -d "$pkg_build_dir" ]; then
            rm -rf "$pkg_build_dir"/* ||
                die "Failed to clean $pkg_build_dir"
        fi
        ;;
    update)
        p_src_pull .
        if ! $(which chibi-scheme >/dev/null 2>&1); then
            for s in clean unpack build install; do
                "$ja_bin_dir/jagen-pkg" chibi-scheme $s tools \
                    || die "Failed to $s chibi-scheme"
            done
        fi
        exec jagen refresh
        ;;
    refresh)
        $(which chibi-scheme >/dev/null 2>&1) ||
            die "Could not find chibi-scheme, try update"
        exec $ja_bin generate build.ninja "$ja_lib_dir/rules.scm"
        ;;
    build)
        shift
        exec ninja "$@"
        ;;
    rebuild)
        shift
        target_path="$1"
        shift
        rm -f "$target_path"
        ninja "$@"
        cat "${target_path}.log"
        ;;
    *)
        die "Unknown command: $1"
        ;;
esac
