#!/bin/sh

[ "$pkg_root" ] ||
    { echo "pkg_root is not set, please source env.sh in the project root.";
      exit 1; }

. "$pkg_root/lib/pkg.sh" ||
    { echo "Failed to load pkg environment"; exit 1; }
. "$pkg_root/lib/help.sh" ||
    { echo "Failed to load help"; exit 1; }

if [ $# = 0 ]; then
    print_help
    exit
fi

build_file="$pkg_build_dir/build.ninja"

rebuild_chibi() {
    for s in clean unpack build install; do
        "$pkg_bin_dir/jagen-pkg" chibi-scheme $s tools \
            || die "Failed to $s chibi-scheme"
    done
}

case $1 in
    help)
        print_help
        ;;
    clean)
        p_clean_dir "$pkg_build_dir"
        exec jagen refresh
        ;;
    update)
        if p_src_is_dirty "$pkg_root"; then
            warning "$pkg_root is dirty, not updating"
        else
            p_src_pull "$pkg_root"
        fi
        exec jagen refresh
        ;;
    refresh)
        message "Refreshing build rules"
        in_path chibi-scheme || rebuild_chibi
        $pkg_bin generate "$build_file" "$pkg_lib_dir/rules.${pkg_sdk}.scm" ||
            die "Failed to generate build rules"
        include "$pkg_root/lib/toolchain"
        generate_toolchain_wrappers
        ;;
    build)
        shift
        in_path chibi-scheme || rebuild_chibi
        $pkg_bin build "$build_file" "$@" || die "Build failed"
        ;;
    rebuild)
        shift
        in_path chibi-scheme || rebuild_chibi
        $pkg_bin rebuild "$build_file" "$@" || die "Rebuild failed"
        ;;
    each)
        shift
        in_path chibi-scheme || rebuild_chibi
        $pkg_bin each "$build_file" "$pkg_lib_dir/rules.${pkg_sdk}.scm" "$@" ||
            die "Failed to run command"
        ;;
    *)
        die "Unknown command: $1"
        ;;
esac
