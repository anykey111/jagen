#!/bin/sh

[ "$jagen_root" ] ||
    { echo "jagen_root is not set, please source env.sh in the project root.";
      exit 1; }

. "$jagen_dir/lib/pkg.sh" ||
    { echo "Failed to load pkg environment"; exit 1; }
. "$jagen_dir/lib/help.sh" ||
    { echo "Failed to load help"; exit 1; }

if [ $# = 0 ]; then
    print_help
    exit
fi

case $1 in
    help)
        print_help
        ;;
    clean)
        p_clean_dir "$pkg_build_dir"
        exec jagen refresh
        ;;
    update)
        if p_src_is_dirty "$jagen_dir"; then
            warning "$jagen_dir is dirty, not updating"
        else
            p_src_pull "$jagen_dir"
        fi
        exec jagen refresh
        ;;
    refresh)
        mkdir -p "$pkg_build_dir"
        mkdir -p "$pkg_build_include_dir"
        _jagen refresh || die "Refresh failed"
        ;;
    *)
        _jagen "$@"
        ;;
esac
