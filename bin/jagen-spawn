#!/bin/sh

for arg; do
    case $1 in
        --forward-ssh)
            forward_ssh=1
            shift
            if [ "$SSH_AUTH_SOCK" ]; then
                sock_dir="$(dirname $SSH_AUTH_SOCK)"
            else
                echo "jagen-spawn: SSH forwarding requested but SSH_AUTH_SOCK is not set"
            fi
            ;;
        --work-dir)
            work_dir=$(realpath "$2")
            shift 2
            ;;
        --temp-dir)
            temp_dir=$(realpath "$2")
            shift 2
            ;;
    esac
done

exec docker run -it --rm --privileged \
    ${forward_ssh:+${SSH_AUTH_SOCK:+--env SSH_AUTH_SOCK=$SSH_AUTH_SOCK}} \
    ${sock_dir:+--volume "$sock_dir:$sock_dir"} \
    ${work_dir:+--volume "$work_dir:/mnt/src/jagen"} \
    ${temp_dir:+--volume "$temp_dir:/mnt/tmp"} \
    --volume /tmp/build:/tmp/build \
    --volumes-from build-data \
    build "$@"
