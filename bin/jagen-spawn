#!/bin/sh

if [ "$SSH_AUTH_SOCK" ]; then
    sock_dir="$(dirname $SSH_AUTH_SOCK)"
else
    echo "Warning: SSH_AUTH_SOCK is not set, not forwarding SSH agent"
fi

while [ "$1" ]; do
    case $1 in
        --work-dir)
            work_dir=$(realpath "$2")
            shift 2
            ;;
        --temp-dir)
            temp_dir=$(realpath "$2")
            shift 2
            ;;
        *)
            echo "Error: unknown argument: $1"
            exit 1
            ;;
    esac
done

exec docker run -it --rm --privileged \
    --env SSH_AUTH_SOCK=$SSH_AUTH_SOCK \
    ${sock_dir:+--volume "$sock_dir:$sock_dir"} \
    ${work_dir:+--volume "$work_dir:/mnt/src/jagen"} \
    ${temp_dir:+--volume "$temp_dir:/mnt/tmp"} \
    --volume /tmp/build:/tmp/build \
    --volumes-from build-data \
    build "$@"
